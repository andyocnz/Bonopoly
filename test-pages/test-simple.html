<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Simple Apps Script - Bonopoly</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }
    .header h1 { font-size: 32px; margin-bottom: 10px; }
    .header p { opacity: 0.9; font-size: 14px; }
    .header .url {
      background: rgba(255,255,255,0.2);
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 11px;
      margin-top: 10px;
      font-family: monospace;
      word-break: break-all;
    }
    .content { padding: 30px; }
    .status {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: 500;
    }
    .status.success { background: #d4edda; color: #155724; border-left: 4px solid #28a745; }
    .status.error { background: #f8d7da; color: #721c24; border-left: 4px solid #dc3545; }
    .status.loading { background: #fff3cd; color: #856404; border-left: 4px solid #ffc107; }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    .section {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      border: 2px solid #e9ecef;
    }
    .section h2 {
      font-size: 18px;
      margin-bottom: 15px;
      color: #333;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.2s;
      margin-right: 8px;
      margin-bottom: 8px;
    }
    .btn:hover { background: #5568d3; transform: translateY(-1px); }
    .btn:active { transform: translateY(0); }
    .btn:disabled { background: #ccc; cursor: not-allowed; }
    .btn.secondary { background: #6c757d; }
    .btn.secondary:hover { background: #5a6268; }
    .btn.success { background: #28a745; }
    .btn.success:hover { background: #218838; }
    .btn.warning { background: #ffc107; color: #000; }
    .btn.warning:hover { background: #e0a800; }
    .result {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 20px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      white-space: pre-wrap;
      word-wrap: break-word;
      max-height: 400px;
      overflow-y: auto;
      margin-top: 15px;
    }
    textarea {
      width: 100%;
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      resize: vertical;
    }
    textarea:focus { outline: none; border-color: #667eea; }
    input {
      width: 100%;
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
      margin-bottom: 10px;
    }
    input:focus { outline: none; border-color: #667eea; }
    .label {
      font-size: 13px;
      font-weight: 600;
      color: #495057;
      margin-bottom: 8px;
      display: block;
    }
    .divider {
      border-top: 2px solid #dee2e6;
      margin: 30px 0;
    }
    /* Floating Notification */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 20px 25px;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      font-weight: 500;
      font-size: 15px;
      z-index: 9999;
      animation: slideIn 0.3s ease-out;
      max-width: 400px;
      min-width: 300px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .notification.success {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      color: white;
    }
    .notification.error {
      background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
      color: white;
    }
    .notification.loading {
      background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
      color: #000;
    }
    .notification .icon {
      font-size: 24px;
      flex-shrink: 0;
    }
    .notification .text {
      flex: 1;
      line-height: 1.4;
    }
    .notification .close {
      cursor: pointer;
      font-size: 20px;
      opacity: 0.8;
      flex-shrink: 0;
      padding: 0 5px;
    }
    .notification .close:hover {
      opacity: 1;
    }
    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üß™ Bonopoly Apps Script Tester</h1>
      <p>Complete test suite: Create, Read, Update, and Authentication</p>
      <div class="url" id="apiUrl">Loading...</div>
    </div>

    <div class="content">
      <div id="status"></div>

      <!-- CONNECTION TEST -->
      <div class="section" style="margin-bottom: 20px;">
        <h2>üîå Connection Test</h2>
        <button class="btn" onclick="testConnection()">Test Connection</button>
        <button class="btn secondary" onclick="clearResults()">Clear Results</button>
      </div>

      <div class="divider"></div>

      <!-- AUTHENTICATION TESTS -->
      <h2 style="margin-bottom: 15px; color: #333;">üîê Authentication Tests</h2>
      <div class="grid">
        <!-- EDUCATOR LOGIN -->
        <div class="section">
          <h2>üë®‚Äçüè´ Educator Login</h2>
          <label class="label">Game Code:</label>
          <input type="text" id="eduGameCode" placeholder="e.g., ABC123" maxlength="6">
          <label class="label">Game PIN:</label>
          <input type="text" id="eduGamePin" placeholder="e.g., 1234" maxlength="4">
          <button class="btn success" onclick="testEducatorLogin()">üîì Login as Educator</button>
          <small style="display:block; margin-top:10px; color:#6c757d;">
            Tip: Create a game first, then use the generated game_code and game_pin
          </small>
        </div>

        <!-- TEAM LOGIN -->
        <div class="section">
          <h2>üë• Team Login</h2>
          <label class="label">Game Code:</label>
          <input type="text" id="teamGameCode" placeholder="e.g., ABC123" maxlength="6">
          <label class="label">Team PIN:</label>
          <input type="text" id="teamPin" placeholder="e.g., 5678" maxlength="4">
          <button class="btn success" onclick="testTeamLogin()">üîì Login as Team</button>
          <small style="display:block; margin-top:10px; color:#6c757d;">
            Tip: Create a team first, then use the generated team_pin
          </small>
        </div>
      </div>

      <div class="divider"></div>

      <!-- CREATE OPERATIONS -->
      <h2 style="margin-bottom: 15px; color: #333;">‚ûï Create (Write) Operations</h2>
      <div class="grid">
        <!-- CREATE GAME -->
        <div class="section">
          <h2>üéÆ Create New Game</h2>
          <button class="btn" onclick="fillGameData()">üìù Fill Sample</button>
          <button class="btn" onclick="createGame()">‚ûï Create Game</button>
          <textarea id="gameData" rows="10"></textarea>
        </div>

        <!-- CREATE TEAM -->
        <div class="section">
          <h2>üë• Create Team</h2>
          <button class="btn" onclick="fillTeamData()">üìù Fill Sample</button>
          <button class="btn" onclick="createTeam()">‚ûï Create Team</button>
          <textarea id="teamData" rows="10"></textarea>
        </div>

        <!-- CREATE DECISION -->
        <div class="section">
          <h2>‚úçÔ∏è Submit Decision</h2>
          <button class="btn" onclick="fillDecisionData()">üìù Fill Sample</button>
          <button class="btn" onclick="submitDecision()">‚ûï Submit</button>
          <textarea id="decisionData" rows="10"></textarea>
        </div>

        <!-- CREATE OUTPUT -->
        <div class="section">
          <h2>üìä Save Output (Results)</h2>
          <button class="btn" onclick="fillOutputData()">üìù Fill Sample</button>
          <button class="btn" onclick="saveOutput()">‚ûï Save Output</button>
          <textarea id="outputData" rows="10"></textarea>
        </div>

        <!-- CREATE SCENARIO -->
        <div class="section">
          <h2>üé≤ Create Round Scenario</h2>
          <button class="btn" onclick="fillScenarioData()">üìù Fill Sample</button>
          <button class="btn" onclick="createScenario()">‚ûï Create</button>
          <textarea id="scenarioData" rows="10"></textarea>
        </div>
      </div>

      <div class="divider"></div>

      <!-- UPDATE OPERATIONS -->
      <h2 style="margin-bottom: 15px; color: #333;">‚úèÔ∏è Update (Edit) Operations</h2>
      <div class="grid">
        <!-- UPDATE GAME -->
        <div class="section">
          <h2>üéÆ Update Game</h2>
          <button class="btn warning" onclick="fillUpdateGame()">üìù Fill Sample</button>
          <button class="btn warning" onclick="updateGame()">‚úèÔ∏è Update Game</button>
          <label class="label">Game Code:</label>
          <input type="text" id="updateGameCode" placeholder="e.g., 64ANKP" maxlength="6">
          <label class="label">Update Data:</label>
          <textarea id="updateGameData" rows="6" placeholder='{"current_round": 2, "status": "active"}'></textarea>
        </div>

        <!-- UPDATE OUTPUT VISIBILITY -->
        <div class="section">
          <h2>üìä Update Output Visibility</h2>
          <button class="btn warning" onclick="fillUpdateOutput()">üìù Fill Sample</button>
          <button class="btn warning" onclick="updateOutput()">‚úèÔ∏è Set Visible</button>
          <label class="label">Game ID:</label>
          <input type="number" id="updateOutputGameId" value="1" min="1">
          <label class="label">Team ID:</label>
          <input type="number" id="updateOutputTeamId" value="1" min="1">
          <label class="label">Round:</label>
          <input type="number" id="updateOutputRound" value="1" min="1">
          <label class="label">Update Data:</label>
          <textarea id="updateOutputData" rows="3" placeholder='{"visible": true}'></textarea>
        </div>

        <!-- UPDATE DECISION STATUS -->
        <div class="section">
          <h2>‚úçÔ∏è Update Decision Status</h2>
          <button class="btn warning" onclick="fillUpdateDecision()">üìù Fill Sample</button>
          <button class="btn warning" onclick="updateDecision()">‚úèÔ∏è Lock Decision</button>
          <label class="label">Game ID:</label>
          <input type="number" id="updateDecisionGameId" value="1" min="1">
          <label class="label">Team ID:</label>
          <input type="number" id="updateDecisionTeamId" value="1" min="1">
          <label class="label">Round:</label>
          <input type="number" id="updateDecisionRound" value="1" min="1">
          <label class="label">Update Data:</label>
          <textarea id="updateDecisionData" rows="3" placeholder='{"status": "locked"}'></textarea>
        </div>
      </div>

      <div class="divider"></div>

      <!-- READ OPERATIONS -->
      <h2 style="margin-bottom: 15px; color: #333;">üìñ Read Operations</h2>
      <div class="grid">
        <div class="section">
          <h2>üìñ Read Data</h2>
          <label class="label">Sheet:</label>
          <select id="readSheet" style="width:100%; padding:8px; margin-bottom:10px; border-radius:6px; border:2px solid #e0e0e0;">
            <option value="Game">Game</option>
            <option value="Teams">Teams</option>
            <option value="Decisions">Decisions</option>
            <option value="Outputs">Outputs</option>
            <option value="Round_Scenarios">Round_Scenarios</option>
          </select>
          <button class="btn" onclick="readAll()">üìñ Read All Rows</button>
          <button class="btn secondary" onclick="readFiltered()">üîç Read Game ID=1</button>
        </div>
      </div>

      <div id="result"></div>
    </div>
  </div>

  <script>
    // Import from config
    const API_URL = 'https://script.google.com/macros/s/AKfycbw_qGZbwl9pHyT7_oASmYBWOBpI0yu4OpCajHaV8j-9qw76CJKcAoPhWR5mb33545IP/exec';

    // Display API URL
    document.getElementById('apiUrl').textContent = API_URL;

    // Store last created game/team for easy testing
    let lastGameCode = '';
    let lastGamePin = '';
    let lastTeamPin = '';
    let notificationTimeout = null;

    function showStatus(message, type = 'loading') {
      // Remove any existing notification
      const existing = document.querySelector('.notification');
      if (existing) {
        existing.remove();
      }
      if (notificationTimeout) {
        clearTimeout(notificationTimeout);
      }

      // Create notification element
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;

      const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚è≥';

      notification.innerHTML = `
        <span class="icon">${icon}</span>
        <span class="text">${message}</span>
        <span class="close" onclick="this.parentElement.remove()">√ó</span>
      `;

      document.body.appendChild(notification);

      // Auto-remove after 5 seconds
      notificationTimeout = setTimeout(() => {
        if (notification && notification.parentElement) {
          notification.style.animation = 'slideOut 0.3s ease-in';
          setTimeout(() => notification.remove(), 300);
        }
      }, 5000);
    }

    function showResult(data) {
      const resultDiv = document.getElementById('result');
      resultDiv.innerHTML = `<div class="result">${JSON.stringify(data, null, 2)}</div>`;
    }

    function clearResults() {
      document.getElementById('result').innerHTML = '';
      document.getElementById('status').style.display = 'none';
    }

    function generateGameCode() {
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      let code = '';
      for (let i = 0; i < 6; i++) {
        code += chars[Math.floor(Math.random() * chars.length)];
      }
      return code;
    }

    function generatePin() {
      return Math.floor(1000 + Math.random() * 9000).toString();
    }

    // ============================================
    // SAMPLE DATA GENERATORS
    // ============================================

    function fillGameData() {
      lastGameCode = generateGameCode();
      lastGamePin = generatePin();
      const data = {
        id: 1,
        game_code: lastGameCode,
        game_pin: lastGamePin,
        name: "MBA Fall 2024",
        educator_email: "professor@university.edu",
        num_teams: 3,
        num_rounds: 3,
        hours_per_round: 168,
        start_time: new Date().toISOString(),
        timezone: "America/New_York",
        current_round: 1,
        template: "medium",
        status: "active"
      };
      document.getElementById('gameData').value = JSON.stringify(data, null, 2);

      // Auto-fill login fields
      document.getElementById('eduGameCode').value = lastGameCode;
      document.getElementById('eduGamePin').value = lastGamePin;
      document.getElementById('teamGameCode').value = lastGameCode;
    }

    function fillTeamData() {
      lastTeamPin = generatePin();
      const data = {
        game_id: 1,
        team_id: 1,
        team_name: "Team Alpha",
        team_pin: lastTeamPin,
        email: "team1@university.edu"
      };
      document.getElementById('teamData').value = JSON.stringify(data, null, 2);

      // Auto-fill team login
      document.getElementById('teamPin').value = lastTeamPin;
    }

    function fillDecisionData() {
      const data = {
        game_id: 1,
        team_id: 1,
        round: 1,
        timestamp: new Date().toISOString(),
        status: "submitted",
        decision_json: JSON.stringify({
          production: {
            us: { total_production: 1200, total_outsource: 0 },
            asia: { total_production: 800, total_outsource: 0 }
          },
          hr: {
            us: { employees: 500, wage: 25000, training_budget: 2000 },
            asia: { employees: 800, wage: 15000, training_budget: 1500 }
          },
          marketing: {
            us: { price: 180000, promotion: 10 },
            asia: { price: 120000, promotion: 15 }
          }
        })
      };
      document.getElementById('decisionData').value = JSON.stringify(data, null, 2);
    }

    function fillOutputData() {
      const data = {
        game_id: 1,
        team_id: 1,
        round: 1,
        visible: true,
        output_json: JSON.stringify({
          pl: { revenue: 180000000, profit_after_tax: 35350000 },
          brand_reputation: 52,
          cumulative_production: 1200
        })
      };
      document.getElementById('outputData').value = JSON.stringify(data, null, 2);
    }

    function fillScenarioData() {
      const deadline = new Date();
      deadline.setDate(deadline.getDate() + 7);
      const data = {
        game_id: 1,
        round: 1,
        deadline: deadline.toISOString(),
        us_scenario_id: 8,
        asia_scenario_id: 8,
        europe_scenario_id: 8
      };
      document.getElementById('scenarioData').value = JSON.stringify(data, null, 2);
    }

    function fillUpdateGame() {
      // Auto-fill with last created game code
      if (lastGameCode) {
        document.getElementById('updateGameCode').value = lastGameCode;
      }
      const data = {
        current_round: 2,
        status: "active"
      };
      document.getElementById('updateGameData').value = JSON.stringify(data, null, 2);
    }

    function fillUpdateOutput() {
      const data = {
        visible: true
      };
      document.getElementById('updateOutputData').value = JSON.stringify(data, null, 2);
    }

    function fillUpdateDecision() {
      const data = {
        status: "locked"
      };
      document.getElementById('updateDecisionData').value = JSON.stringify(data, null, 2);
    }

    // ============================================
    // AUTHENTICATION TESTS
    // ============================================

    async function testEducatorLogin() {
      const gameCode = document.getElementById('eduGameCode').value;
      const gamePin = document.getElementById('eduGamePin').value;

      if (!gameCode || !gamePin) {
        showStatus('‚ùå Please enter game code and game PIN', 'error');
        return;
      }

      showStatus('Testing educator login...', 'loading');

      // For now, just test reading the game
      try {
        const filters = JSON.stringify({ game_code: gameCode, game_pin: gamePin });
        const url = `${API_URL}?action=read&sheet=Game&filters=${encodeURIComponent(filters)}`;
        const response = await fetch(url);
        const data = await response.json();

        if (data.success && data.data && data.data.length > 0) {
          showStatus('‚úÖ Educator authenticated!', 'success');
          showResult({
            success: true,
            role: 'educator',
            game: data.data[0],
            message: 'Login successful'
          });
        } else {
          showStatus('‚ùå Invalid game code or PIN', 'error');
          showResult({ success: false, error: 'Invalid credentials' });
        }
      } catch (error) {
        showStatus('‚ùå Error: ' + error.message, 'error');
        showResult({ error: error.message });
      }
    }

    async function testTeamLogin() {
      const gameCode = document.getElementById('teamGameCode').value;
      const teamPin = document.getElementById('teamPin').value;

      if (!gameCode || !teamPin) {
        showStatus('‚ùå Please enter game code and team PIN', 'error');
        return;
      }

      showStatus('Testing team login...', 'loading');

      try {
        // First get game
        const gameFilters = JSON.stringify({ game_code: gameCode });
        const gameUrl = `${API_URL}?action=read&sheet=Game&filters=${encodeURIComponent(gameFilters)}`;
        const gameResponse = await fetch(gameUrl);
        const gameData = await gameResponse.json();

        if (!gameData.success || !gameData.data || gameData.data.length === 0) {
          showStatus('‚ùå Invalid game code', 'error');
          showResult({ success: false, error: 'Game not found' });
          return;
        }

        const game = gameData.data[0];

        // Then get team
        const teamFilters = JSON.stringify({ game_id: game.id, team_pin: teamPin });
        const teamUrl = `${API_URL}?action=read&sheet=Teams&filters=${encodeURIComponent(teamFilters)}`;
        const teamResponse = await fetch(teamUrl);
        const teamData = await teamResponse.json();

        if (teamData.success && teamData.data && teamData.data.length > 0) {
          showStatus('‚úÖ Team authenticated!', 'success');
          showResult({
            success: true,
            role: 'team',
            game: game,
            team: teamData.data[0],
            message: 'Login successful as ' + teamData.data[0].team_name
          });
        } else {
          showStatus('‚ùå Invalid team PIN', 'error');
          showResult({ success: false, error: 'Invalid team PIN' });
        }
      } catch (error) {
        showStatus('‚ùå Error: ' + error.message, 'error');
        showResult({ error: error.message });
      }
    }

    // ============================================
    // CREATE OPERATIONS
    // ============================================

    async function testConnection() {
      showStatus('Testing connection...', 'loading');
      try {
        const response = await fetch(`${API_URL}?action=test`);
        const data = await response.json();
        showStatus(data.success ? '‚úÖ Connected!' : '‚ùå Failed', data.success ? 'success' : 'error');
        showResult(data);
      } catch (error) {
        showStatus('‚ùå Error: ' + error.message, 'error');
        showResult({ error: error.message });
      }
    }

    async function createGame() {
      const dataStr = document.getElementById('gameData').value;
      if (!dataStr) { fillGameData(); return; }

      showStatus('Creating game...', 'loading');
      try {
        const url = `${API_URL}?action=write&sheet=Game&data=${encodeURIComponent(dataStr)}`;
        const response = await fetch(url);
        const data = await response.json();
        showStatus(data.success ? `‚úÖ Game created! Code: ${lastGameCode}, PIN: ${lastGamePin}` : '‚ùå Failed', data.success ? 'success' : 'error');
        showResult(data);
      } catch (error) {
        showStatus('‚ùå Error: ' + error.message, 'error');
        showResult({ error: error.message });
      }
    }

    async function createTeam() {
      const dataStr = document.getElementById('teamData').value;
      if (!dataStr) { fillTeamData(); return; }

      showStatus('Creating team...', 'loading');
      try {
        const url = `${API_URL}?action=write&sheet=Teams&data=${encodeURIComponent(dataStr)}`;
        const response = await fetch(url);
        const data = await response.json();
        showStatus(data.success ? `‚úÖ Team created! PIN: ${lastTeamPin}` : '‚ùå Failed', data.success ? 'success' : 'error');
        showResult(data);
      } catch (error) {
        showStatus('‚ùå Error: ' + error.message, 'error');
        showResult({ error: error.message });
      }
    }

    async function submitDecision() {
      const dataStr = document.getElementById('decisionData').value;
      if (!dataStr) { fillDecisionData(); return; }

      showStatus('Submitting decision...', 'loading');
      try {
        const url = `${API_URL}?action=write&sheet=Decisions&data=${encodeURIComponent(dataStr)}`;
        const response = await fetch(url);
        const data = await response.json();
        showStatus(data.success ? '‚úÖ Decision submitted!' : '‚ùå Failed', data.success ? 'success' : 'error');
        showResult(data);
      } catch (error) {
        showStatus('‚ùå Error: ' + error.message, 'error');
        showResult({ error: error.message });
      }
    }

    async function saveOutput() {
      const dataStr = document.getElementById('outputData').value;
      if (!dataStr) { fillOutputData(); return; }

      showStatus('Saving output...', 'loading');
      try {
        const url = `${API_URL}?action=write&sheet=Outputs&data=${encodeURIComponent(dataStr)}`;
        const response = await fetch(url);
        const data = await response.json();
        showStatus(data.success ? '‚úÖ Output saved!' : '‚ùå Failed', data.success ? 'success' : 'error');
        showResult(data);
      } catch (error) {
        showStatus('‚ùå Error: ' + error.message, 'error');
        showResult({ error: error.message });
      }
    }

    async function createScenario() {
      const dataStr = document.getElementById('scenarioData').value;
      if (!dataStr) { fillScenarioData(); return; }

      showStatus('Creating scenario...', 'loading');
      try {
        const url = `${API_URL}?action=write&sheet=Round_Scenarios&data=${encodeURIComponent(dataStr)}`;
        const response = await fetch(url);
        const data = await response.json();
        showStatus(data.success ? '‚úÖ Scenario created!' : '‚ùå Failed', data.success ? 'success' : 'error');
        showResult(data);
      } catch (error) {
        showStatus('‚ùå Error: ' + error.message, 'error');
        showResult({ error: error.message });
      }
    }

    // ============================================
    // UPDATE OPERATIONS
    // ============================================

    async function updateGame() {
      const dataStr = document.getElementById('updateGameData').value;
      if (!dataStr) { fillUpdateGame(); return; }

      const gameCode = document.getElementById('updateGameCode').value;
      if (!gameCode) {
        showStatus('‚ùå Please enter Game Code', 'error');
        return;
      }

      showStatus('Updating game...', 'loading');
      try {
        const filters = JSON.stringify({ game_code: gameCode });
        const url = `${API_URL}?action=update&sheet=Game&filters=${encodeURIComponent(filters)}&data=${encodeURIComponent(dataStr)}`;
        const response = await fetch(url);
        const data = await response.json();
        showStatus(data.success ? `‚úÖ Game ${gameCode} updated!` : '‚ùå Failed', data.success ? 'success' : 'error');
        showResult(data);
      } catch (error) {
        showStatus('‚ùå Error: ' + error.message, 'error');
        showResult({ error: error.message });
      }
    }

    async function updateOutput() {
      const dataStr = document.getElementById('updateOutputData').value;
      if (!dataStr) { fillUpdateOutput(); return; }

      const gameId = document.getElementById('updateOutputGameId').value;
      const teamId = document.getElementById('updateOutputTeamId').value;
      const round = document.getElementById('updateOutputRound').value;

      if (!gameId || !teamId || !round) {
        showStatus('‚ùå Please enter Game ID, Team ID, and Round', 'error');
        return;
      }

      showStatus('Updating output...', 'loading');
      try {
        const filters = JSON.stringify({
          game_id: parseInt(gameId),
          team_id: parseInt(teamId),
          round: parseInt(round)
        });
        const url = `${API_URL}?action=update&sheet=Outputs&filters=${encodeURIComponent(filters)}&data=${encodeURIComponent(dataStr)}`;
        const response = await fetch(url);
        const data = await response.json();
        showStatus(data.success ? `‚úÖ Output updated (Game:${gameId}, Team:${teamId}, Round:${round})` : '‚ùå Failed', data.success ? 'success' : 'error');
        showResult(data);
      } catch (error) {
        showStatus('‚ùå Error: ' + error.message, 'error');
        showResult({ error: error.message });
      }
    }

    async function updateDecision() {
      const dataStr = document.getElementById('updateDecisionData').value;
      if (!dataStr) { fillUpdateDecision(); return; }

      const gameId = document.getElementById('updateDecisionGameId').value;
      const teamId = document.getElementById('updateDecisionTeamId').value;
      const round = document.getElementById('updateDecisionRound').value;

      if (!gameId || !teamId || !round) {
        showStatus('‚ùå Please enter Game ID, Team ID, and Round', 'error');
        return;
      }

      showStatus('Updating decision...', 'loading');
      try {
        const filters = JSON.stringify({
          game_id: parseInt(gameId),
          team_id: parseInt(teamId),
          round: parseInt(round)
        });
        const url = `${API_URL}?action=update&sheet=Decisions&filters=${encodeURIComponent(filters)}&data=${encodeURIComponent(dataStr)}`;
        const response = await fetch(url);
        const data = await response.json();
        showStatus(data.success ? `‚úÖ Decision updated (Game:${gameId}, Team:${teamId}, Round:${round})` : '‚ùå Failed', data.success ? 'success' : 'error');
        showResult(data);
      } catch (error) {
        showStatus('‚ùå Error: ' + error.message, 'error');
        showResult({ error: error.message });
      }
    }

    // ============================================
    // READ OPERATIONS
    // ============================================

    async function readAll() {
      const sheet = document.getElementById('readSheet').value;
      showStatus(`Reading all rows from ${sheet}...`, 'loading');
      try {
        const url = `${API_URL}?action=read&sheet=${sheet}`;
        const response = await fetch(url);
        const data = await response.json();
        showStatus(
          data.success ? `‚úÖ Found ${data.data?.length || 0} rows` : '‚ùå Failed',
          data.success ? 'success' : 'error'
        );
        showResult(data);
      } catch (error) {
        showStatus('‚ùå Error: ' + error.message, 'error');
        showResult({ error: error.message });
      }
    }

    async function readFiltered() {
      const sheet = document.getElementById('readSheet').value;
      const filters = JSON.stringify({ game_id: 1 });
      showStatus(`Reading ${sheet} where game_id=1...`, 'loading');
      try {
        const url = `${API_URL}?action=read&sheet=${sheet}&filters=${encodeURIComponent(filters)}`;
        const response = await fetch(url);
        const data = await response.json();
        showStatus(
          data.success ? `‚úÖ Found ${data.data?.length || 0} rows` : '‚ùå Failed',
          data.success ? 'success' : 'error'
        );
        showResult(data);
      } catch (error) {
        showStatus('‚ùå Error: ' + error.message, 'error');
        showResult({ error: error.message });
      }
    }

    // Auto-fill on load
    window.onload = () => {
      fillGameData();
      fillTeamData();
      fillDecisionData();
      fillOutputData();
      fillScenarioData();
      fillUpdateGame();
      fillUpdateOutput();
      fillUpdateDecision();
      testConnection();
    };
  </script>
</body>
</html>
